{% extends "layout.html" %}
{% block content %}
  <!-- Section de progression -->
  {% include 'components/progress-section.html' %}
  
  <!-- Tableau des résultats QR -->
  {% include 'components/results-table.html' %}
  
  <!-- Extractions IA -->
  {% include 'components/ai-results.html' %}
  
  <!-- Section par page -->
  {% include 'components/by-page-section.html' %}
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="/static/js/services/socket-service.js"></script>
  <script src="/static/js/components/progress-tracker.js"></script>
  <script src="/static/js/components/results-display.js"></script>
  <script src="/static/js/components/ai-display.js"></script>
  <script>
    // Configuration globale
    window.SCAN_CONFIG = {
      scanId: "{{ scan_id }}",
      socketUrl: window.location.origin
    };
    
    // Initialisation de l'application
    document.addEventListener('DOMContentLoaded', function() {
      const socketService = new SocketService(window.SCAN_CONFIG.scanId);
      const progressTracker = new ProgressTracker();
      const resultsDisplay = new ResultsDisplay();
      const aiDisplay = new AIDisplay();
      
      // Configuration des événements
      socketService.onProgress((data) => progressTracker.updateProgress(data.message));
      socketService.onComplete((data) => {
        progressTracker.hideProgress();
        resultsDisplay.displayStats(data.results.stats);
        resultsDisplay.displayQRResults(data.results.url_results || []);
        aiDisplay.displayAIExtractions(data.results.ai_extraction);
        resultsDisplay.displayTextExtractions(data.results.extractions || []);
        resultsDisplay.displayByPageSection(data.results.url_results || [], data.results.ai_extraction);
        resultsDisplay.showSuccessMessage();
      });
      socketService.onError((data) => progressTracker.showError(data.error));
      
      // Démarrage
      socketService.connect();
    });
  </script>
{% endblock %}