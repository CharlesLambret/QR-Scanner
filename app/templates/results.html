{% extends "layout.html" %}
{% block content %}
  <!-- Section de progression -->
  <div id="progress-section">
    <div id="progress" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4 w-1/3 mx-auto">
      En attente du d√©marrage du scan...
    </div>
  </div>
  
  <!-- Section par page -->
  {% include 'components/by-page-section.html' %}
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="/static/js/services/socket-service.js"></script>
  <script src="/static/js/components/progress-tracker.js"></script>
  <script src="/static/js/components/results-display.js"></script>
  <script>
    // Configuration globale
    window.SCAN_CONFIG = {
      scanId: "{{ scan_id }}",
      socketUrl: window.location.origin
    };
    
    // Initialisation de l'application
    document.addEventListener('DOMContentLoaded', function() {
      const socketService = new SocketService(window.SCAN_CONFIG.scanId);
      const progressTracker = new ProgressTracker();
      const resultsDisplay = new ResultsDisplay();
      
      // Configuration des √©v√©nements
      socketService.onProgress((data) => progressTracker.updateProgress(data.message));
      socketService.onComplete((data) => {
        progressTracker.hideProgress();
        resultsDisplay.displayByPageSection(data.results.url_results || [], data.results.ai_extraction);
        resultsDisplay.showSuccessMessage();
        
        // Afficher le bouton de t√©l√©chargement CSV
        showCSVDownloadButton();
      });
      socketService.onError((data) => progressTracker.showError(data.error));
      
      // D√©marrage
      socketService.connect();
    });
    
    // Fonction pour afficher le bouton de t√©l√©chargement CSV
    function showCSVDownloadButton() {
      const headerActions = document.getElementById('header-actions');
      const downloadBtn = document.getElementById('download-csv-btn');
      
      if (headerActions && downloadBtn) {
        headerActions.classList.remove('hidden');
        
        // Ajouter l'√©v√©nement de clic
        downloadBtn.addEventListener('click', function() {
          downloadCSV();
        });
      }
    }
    
    // Fonction pour t√©l√©charger le CSV
    function downloadCSV() {
      const scanId = window.SCAN_CONFIG.scanId;
      
      if (!scanId) {
        alert('Erreur: Identifiant de scan non trouv√©');
        return;
      }
      
      // Cr√©er un lien de t√©l√©chargement et le d√©clencher
      const downloadUrl = `/export-csv/${scanId}`;
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = '';
      link.style.display = 'none';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log(`üìÑ CSV download initiated for scan_id: ${scanId}`);
    }
  </script>
{% endblock %}