{% extends "layout.html" %}
{% block content %}
<div id="progress" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
  En attente du dÃ©marrage du scan...
</div>

<!-- Statistiques -->
<div id="stats" class="w-full  hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
  <h3 class="font-semibold">Statistiques du scan :</h3>
  <ul id="stats-list" class="list-disc list-inside mt-2"></ul>
</div>

<!-- Tableau des rÃ©sultats -->
<table id="results-table" class="w-full  hidden table-auto border-collapse border border-gray-300 mb-6">
  <thead class="bg-gray-100">
    <tr>
      <th class="border px-4 py-2">Page</th>
      <th class="border px-4 py-2">URL</th>
      <th class="border px-4 py-2">Domaine</th>
      <th class="border px-4 py-2">Status HTTP</th>
      <th class="border px-4 py-2">ParamÃ¨tres UTM</th>
      <th class="border px-4 py-2">Validation Domaine</th>
      <th class="border px-4 py-2">Validation UTM</th>
      <th class="border px-4 py-2">Validation Texte</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Extractions de texte (si activÃ©es) -->
<div id="extractions" class="hidden">
  <h3 class="text-lg font-semibold mb-2">Extractions de texte (pages impaires) :</h3>
  <div id="extractions-content" class="bg-gray-100 border rounded p-4 max-h-64 overflow-y-auto"></div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const scanId = "{{ scan_id }}";
  console.log("ğŸ” Script dÃ©marrÃ©, scanId:", scanId);
  
  const socket = io();
  console.log("ğŸ”Œ Socket.IO instance crÃ©Ã©e");

  socket.on("scan_progress", data => {
    console.log("ğŸ“Š Event scan_progress reÃ§u:", data);
    console.log("ğŸ“Š Comparaison scanId - ReÃ§u:", data.scan_id, "Attendu:", scanId, "Match:", data.scan_id === scanId);
    console.log("ğŸ“Š Type de scanId reÃ§u:", typeof data.scan_id, "Type attendu:", typeof scanId);
    
    if (data.scan_id === scanId) {
      console.log("âœ… scan_progress: mise Ã  jour du message:", data.message);
      document.getElementById("progress").innerText = data.message;
    } else {
      console.log("âŒ scan_progress: scanId ne correspond pas");
      console.log("âŒ DÃ©tail: '" + data.scan_id + "' !== '" + scanId + "'");
    }
  });

  socket.on("scan_complete", data => {
    console.log("ğŸ‰ Event scan_complete reÃ§u:", data);
    console.log("ğŸ‰ Comparaison scanId - ReÃ§u:", data.scan_id, "Attendu:", scanId, "Match:", data.scan_id === scanId);
    console.log("ğŸ‰ Structure data.results:", data.results);
    
    if (data.scan_id === scanId) {
      console.log("âœ… scan_complete: traitement des rÃ©sultats...");
      
      // Cacher le message de progression
      console.log("ğŸ”§ Masquage du message de progression");
      document.getElementById("progress").style.display = "none";
      
      // Afficher les statistiques
      console.log("ğŸ“ˆ Traitement des statistiques...");
      const statsDiv = document.getElementById("stats");
      const statsList = document.getElementById("stats-list");
      const stats = data.results.stats;
      console.log("ğŸ“ˆ Stats reÃ§ues:", stats);
      
      if (stats) {
        statsList.innerHTML = `
          <li>Pages totales : ${stats.total_pages}</li>
          <li>Pages avec QR codes : ${stats.pages_with_qr}</li>
          <li>URLs uniques trouvÃ©es : ${stats.unique_urls}</li>
          <li>Lignes de texte extraites : ${stats.extracted_lines}</li>
        `;
        statsDiv.classList.remove("hidden");
        console.log("ğŸ“ˆ Statistiques affichÃ©es");
      } else {
        console.log("âŒ Pas de statistiques dans les donnÃ©es");
      }
      
      // Afficher les rÃ©sultats URL
      console.log("ğŸ”— Traitement des URLs...");
      const tbody = document.querySelector("#results-table tbody");
      const urlResults = data.results.url_results || [];
      console.log("ğŸ”— URL results:", urlResults, "Length:", urlResults.length);
      
      if (urlResults.length > 0) {
        console.log("ğŸ”— Affichage du tableau des URLs");
        document.getElementById("results-table").classList.remove("hidden");
        
        urlResults.forEach((result, index) => {
          console.log(`ğŸ”— Traitement URL ${index + 1}:`, result);
          const tr = document.createElement("tr");
          const utmText = result.utm ? 
            Object.entries(result.utm).map(([k,v]) => `${k}: ${v}`).join(", ") : 
            "Aucun";
          
          // Helper function to create validation status cell
          const getValidationStatus = (validationResult) => {
            if (validationResult === null || validationResult === undefined) {
              return '<span class="text-gray-500">Non testÃ©</span>';
            } else if (validationResult === true) {
              return '<span class="text-green-600 font-semibold">âœ“ Valide</span>';
            } else {
              return '<span class="text-red-600 font-semibold">âœ— Invalide</span>';
            }
          };
            
          tr.innerHTML = `
            <td class="border px-4 py-2">${result.page}</td>
            <td class="border px-4 py-2">
              <a href="${result.url}" target="_blank" class="text-blue-600 hover:underline" title="${result.url}">
                ${result.url.length > 50 ? result.url.substring(0, 50) + '...' : result.url}
              </a>
            </td>
            <td class="border px-4 py-2">${result.netloc || 'N/A'}</td>
            <td class="border px-4 py-2">
              <span class="${result.http_status === 200 ? 'text-green-600' : 'text-red-600'}">
                ${result.http_status || 'N/A'}
              </span>
            </td>
            <td class="border px-4 py-2 text-sm">${utmText}</td>
            <td class="border px-4 py-2 text-sm">${getValidationStatus(result.domain_valid)}</td>
            <td class="border px-4 py-2 text-sm">${getValidationStatus(result.utm_valid)}</td>
            <td class="border px-4 py-2 text-sm">${getValidationStatus(result.text_search_valid)}</td>
          `;
          tbody.appendChild(tr);
        });
        console.log("ğŸ”— Tableau des URLs peuplÃ© avec", urlResults.length, "entrÃ©es");
      } else {
        console.log("âš ï¸ Aucune URL trouvÃ©e, affichage du message d'information");
        // Aucune URL trouvÃ©e
        const noResultsDiv = document.createElement("div");
        noResultsDiv.className = "bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4";
        noResultsDiv.innerText = "Aucun QR code avec URL dÃ©tectÃ© dans ce PDF.";
        document.getElementById("stats").after(noResultsDiv);
      }
      
      // Afficher les extractions si disponibles
      console.log("ğŸ“ Traitement des extractions de texte...");
      const extractions = data.results.extractions || [];
      console.log("ğŸ“ Extractions:", extractions, "Length:", extractions.length);
      
      if (extractions.length > 0) {
        console.log("ğŸ“ Affichage des extractions");
        const extractionsDiv = document.getElementById("extractions");
        const extractionsContent = document.getElementById("extractions-content");
        
        extractionsContent.innerHTML = extractions
          .map(ext => `<div class="mb-1"><strong>Page ${ext.page}:</strong> ${ext.line}</div>`)
          .join("");
        
        extractionsDiv.classList.remove("hidden");
        console.log("ğŸ“ Extractions affichÃ©es");
      } else {
        console.log("ğŸ“ Aucune extraction de texte");
      }
      
      // Message de fin
      console.log("ğŸ‰ Ajout du message de succÃ¨s");
      const successDiv = document.createElement("div");
      successDiv.className = "bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mt-4";
      successDiv.innerText = "âœ… Scan terminÃ© avec succÃ¨s !";
      document.querySelector("main").appendChild(successDiv);
      console.log("ğŸ‰ Traitement terminÃ© avec succÃ¨s");
    } else {
      console.log("âŒ scan_complete: scanId ne correspond pas");
    }
  });

  socket.on("scan_error", data => {
    console.log("âŒ Event scan_error reÃ§u:", data);
    if (data.scan_id === scanId) {
      document.getElementById("progress").innerHTML = `
        <span class="text-red-600">âŒ Erreur pendant le scan: ${data.error}</span>
      `;
      document.getElementById("progress").className = "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4";
    }
  });

  socket.on("connect", () => {
    console.log("ğŸ”Œ Socket.IO connectÃ© avec succÃ¨s");
    console.log("ğŸ”Œ Socket ID:", socket.id);
    
    // Signaler au serveur que ce client est prÃªt pour ce scan
    console.log("ğŸ“¡ Envoi de client_ready pour scanId:", scanId);
    socket.emit("client_ready", { scan_id: scanId });
  });

  socket.on("disconnect", () => {
    console.log("ğŸ”Œ Socket.IO dÃ©connectÃ©");
  });

  socket.on("error", (error) => {
    console.log("âŒ Erreur Socket.IO:", error);
  });

  // Log de tous les Ã©vÃ©nements reÃ§us
  socket.onAny((eventName, ...args) => {
    console.log("ğŸ“¡ Event reÃ§u:", eventName, "Args:", args);
  });

  // Test d'envoi d'un message au serveur
  setTimeout(() => {
    console.log("ğŸ§ª Test d'envoi de message au serveur");
    socket.emit("test_message", { scanId: scanId, message: "Test depuis le client" });
  }, 1000);
</script>
{% endblock %}
